<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SQLDatabaseEngine.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sample-spring-boot-kitchensink</a> &gt; <a href="index.source.html" class="el_package">com.example.bot.spring</a> &gt; <span class="el_source">SQLDatabaseEngine.java</span></div><h1>SQLDatabaseEngine.java</h1><pre class="source lang-java linenums">package com.example.bot.spring;

import lombok.extern.slf4j.Slf4j;
import javax.annotation.PostConstruct;
import javax.sql.DataSource;
import java.sql.*;
import java.net.URISyntaxException;
import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.net.URI;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.StringJoiner;
import java.time.LocalDate;


/**
*	The SQLDatabaseEngine is the PostgreSQL database engine that handles all functions that accesses the database.
*
*	@since 2017-10-10
*/
<span class="fc" id="L23">@Slf4j</span>
<span class="fc" id="L24">public class SQLDatabaseEngine {</span>
	/** 
	*	Gets connection to the PostgreSQL Database.
	*/
	private Connection getConnection() throws URISyntaxException, Exception {
		Connection connection;
<span class="fc" id="L30">		URI dbUri = new URI(System.getenv(&quot;DATABASE_URL&quot;));</span>

<span class="fc" id="L32">		String username = dbUri.getUserInfo().split(&quot;:&quot;)[0];</span>
<span class="fc" id="L33">		String password = dbUri.getUserInfo().split(&quot;:&quot;)[1];</span>
<span class="fc" id="L34">		String dbUrl = &quot;jdbc:postgresql://&quot; + dbUri.getHost() + ':' + dbUri.getPort() + dbUri.getPath() +  &quot;?ssl=true&amp;sslfactory=org.postgresql.ssl.NonValidatingFactory&quot;;</span>

<span class="fc" id="L36">		log.info(&quot;Username: {} Password: {}&quot;, username, password);</span>
<span class="fc" id="L37">		log.info (&quot;dbUrl: {}&quot;, dbUrl);</span>
		
<span class="fc" id="L39">		connection = DriverManager.getConnection(dbUrl, username, password);</span>

<span class="fc" id="L41">		return connection;</span>
	}
	
	
	/**
	*	Writes the input user info into the database.
	*	Writes into both the userinfo and userallergies databases.
	*	
	*	@param userId the user's Line ID.
	*	@param age the user's age.
	*	@param gender the user's gender, either &quot;male&quot; or &quot;female&quot;.
	*	@param height the user's height, in meters.
	*	@param weight the user's weight, in kilograms.
	*	@param allergies a list of the user's allergies.
	*	@param diet the user's dieting goals, either &quot;little_diet&quot;, &quot;normal&quot; or &quot;serious_diet&quot;.
	*	@param topic the user's topic within Rivescript.
	*	@param state the user's state within Rivescript.
	*/
	public void writeUserInfo(String userId, int age, String gender, double height, double weight, ArrayList&lt;String&gt; allergies, String diet, String topic, String state) {
<span class="fc" id="L60">		Connection connection = null;</span>
<span class="fc" id="L61">		PreparedStatement stmtUpdate = null;</span>
		
		try {
<span class="fc" id="L64">			connection = this.getConnection();</span>
			
			// Delete user info if it already exists
<span class="fc" id="L67">			stmtUpdate = connection.prepareStatement(</span>
				&quot;DELETE FROM userinfo &quot; +
				&quot;WHERE userId = ?&quot;
			);
<span class="fc" id="L71">			stmtUpdate.setString(1, userId);</span>
<span class="fc" id="L72">			stmtUpdate.executeUpdate();</span>

			// Delete user allergies if it already exists
<span class="fc" id="L75">			stmtUpdate = connection.prepareStatement(</span>
				&quot;DELETE FROM userallergies &quot; +
				&quot;WHERE userId = ?&quot;
			);
<span class="fc" id="L79">			stmtUpdate.setString(1, userId);</span>
<span class="fc" id="L80">			stmtUpdate.executeUpdate();	</span>
			
			// Insert user info into the database
<span class="fc" id="L83">			stmtUpdate = connection.prepareStatement(</span>
				&quot;INSERT INTO userinfo &quot; +
				&quot;VALUES (?, ?, ?, ?, ?, ?, ?, ?)&quot;
			);
<span class="fc" id="L87">			stmtUpdate.setString(1, userId);</span>
<span class="fc" id="L88">			stmtUpdate.setInt(2, age);</span>
<span class="fc" id="L89">			stmtUpdate.setString(3, gender);</span>
<span class="fc" id="L90">			stmtUpdate.setDouble(4, height);</span>
<span class="fc" id="L91">			stmtUpdate.setDouble(5, weight);</span>
<span class="fc" id="L92">			stmtUpdate.setString(6, diet);</span>
<span class="fc" id="L93">			stmtUpdate.setString(7, topic);</span>
<span class="fc" id="L94">			stmtUpdate.setString(8, state);</span>
<span class="fc" id="L95">			stmtUpdate.executeUpdate();</span>

			// Insert user allergies into the database if they have any
<span class="fc bfc" id="L98" title="All 2 branches covered.">			if (allergies.size() != 0) {</span>
<span class="fc" id="L99">				stmtUpdate = connection.prepareStatement(</span>
					&quot;INSERT INTO userallergies &quot; +
					&quot;VALUES (?, ?)&quot;
				);
<span class="fc bfc" id="L103" title="All 2 branches covered.">				for (String allergy: allergies) {</span>
<span class="fc" id="L104">					stmtUpdate.setString(1, userId);</span>
<span class="fc" id="L105">					stmtUpdate.setString(2, allergy);</span>
<span class="fc" id="L106">					stmtUpdate.addBatch();</span>
<span class="fc" id="L107">				}</span>
<span class="fc" id="L108">				stmtUpdate.executeBatch();					</span>
			}
<span class="fc" id="L110">		} catch (Exception e) {</span>
<span class="fc" id="L111">			log.info(&quot;Exception while connecting to database: {}&quot;, e.toString());</span>
		} finally {
<span class="nc" id="L113">			try {</span>
<span class="pc" id="L114">				stmtUpdate.close();</span>
<span class="pc" id="L115">				connection.close();</span>
<span class="pc" id="L116">			} catch (Exception e) {</span>
<span class="pc" id="L117">				log.info(&quot;Exception while closing connection to database: {}&quot;, e.toString());</span>
<span class="pc" id="L118">			}</span>
<span class="pc" id="L119">		}</span>
<span class="fc" id="L120">	}</span>


	/**
	*	Sets the String value of a single column for the specified user in the userinfo table.
	*
	*	@param userId the user's Line ID.
	*	@param info the name of the column whose value is to be overwritten.
	*	@param newInfo the new String value to be written.
	*/
	public void setUserInfo(String userId, String info, String newInfo) {
<span class="fc" id="L131">		Connection connection = null;</span>
<span class="fc" id="L132">		PreparedStatement stmtUpdate = null;</span>
<span class="fc" id="L133">		String statement = null;</span>
		
		try {
<span class="fc" id="L136">			connection = this.getConnection();</span>
			
<span class="fc" id="L138">			statement = &quot;UPDATE userinfo &quot; +</span>
						&quot;SET &quot; + info + &quot; = ? &quot; +
						&quot;WHERE userid = ?&quot;;
<span class="fc" id="L141">			stmtUpdate = connection.prepareStatement(statement);</span>
<span class="fc" id="L142">			stmtUpdate.setString(1, newInfo);</span>
<span class="fc" id="L143">			stmtUpdate.setString(2, userId);</span>
<span class="fc" id="L144">			stmtUpdate.executeUpdate();</span>
<span class="fc" id="L145">		} catch (Exception e) {</span>
<span class="fc" id="L146">			log.info(&quot;Exception while connecting to database: {}&quot;, e.toString());</span>
		} finally {
<span class="nc" id="L148">			try {</span>
<span class="pc" id="L149">				stmtUpdate.close();</span>
<span class="pc" id="L150">				connection.close();</span>
<span class="pc" id="L151">			} catch (Exception e) {</span>
<span class="pc" id="L152">				log.info(&quot;Exception while closing connection to database: {}&quot;, e.toString());</span>
<span class="pc" id="L153">			}</span>
<span class="pc" id="L154">		}</span>
<span class="fc" id="L155">	}</span>


	/**
	*	Sets the int value of a single column for the specified user in the userinfo table.
	*
	*	@param userId the user's Line ID.
	*	@param info the name of the column whose value is to be overwritten.
	*	@param newInfo the new int value to be written.
	*/
	public void setUserInfo(String userId, String info, int newInfo) {
<span class="fc" id="L166">		Connection connection = null;</span>
<span class="fc" id="L167">		PreparedStatement stmtUpdate = null;</span>
<span class="fc" id="L168">		String statement = null;</span>
		
		try {
<span class="fc" id="L171">			connection = this.getConnection();</span>
			
<span class="fc" id="L173">			statement = &quot;UPDATE userinfo &quot; +</span>
						&quot;SET &quot; + info + &quot; = ? &quot; +
						&quot;WHERE userid = ?&quot;;
<span class="fc" id="L176">			stmtUpdate = connection.prepareStatement(statement);</span>
<span class="fc" id="L177">			stmtUpdate.setInt(1, newInfo);</span>
<span class="fc" id="L178">			stmtUpdate.setString(2, userId);</span>
<span class="fc" id="L179">			stmtUpdate.executeUpdate();</span>
<span class="nc" id="L180">		} catch (Exception e) {</span>
<span class="nc" id="L181">			log.info(&quot;Exception while connecting to database: {}&quot;, e.toString());</span>
		} finally {
<span class="nc" id="L183">			try {</span>
<span class="pc" id="L184">				stmtUpdate.close();</span>
<span class="pc" id="L185">				connection.close();</span>
<span class="nc" id="L186">			} catch (Exception e) {</span>
<span class="nc" id="L187">				log.info(&quot;Exception while closing connection to database: {}&quot;, e.toString());</span>
<span class="pc" id="L188">			}</span>
<span class="nc" id="L189">		}</span>
<span class="fc" id="L190">	}</span>


	/**
	*	Sets the double value of a single column for the specified user in the userinfo table.
	*
	*	@param userId the user's Line ID.
	*	@param info the name of the column whose value is to be overwritten.
	*	@param newInfo the new double value to be written.
	*/
	public void setUserInfo(String userId, String info, double newInfo) {
<span class="fc" id="L201">		Connection connection = null;</span>
<span class="fc" id="L202">		PreparedStatement stmtUpdate = null;</span>
<span class="fc" id="L203">		String statement = null;</span>
		
		try {
<span class="fc" id="L206">			connection = this.getConnection();</span>
			
<span class="fc" id="L208">			statement = &quot;UPDATE userinfo &quot; +</span>
						&quot;SET &quot; + info + &quot; = ? &quot; +
						&quot;WHERE userid = ?&quot;;
<span class="fc" id="L211">			stmtUpdate = connection.prepareStatement(statement);</span>
<span class="fc" id="L212">			stmtUpdate.setDouble(1, newInfo);</span>
<span class="fc" id="L213">			stmtUpdate.setString(2, userId);</span>
<span class="fc" id="L214">			stmtUpdate.executeUpdate();</span>
<span class="fc" id="L215">		} catch (Exception e) {</span>
<span class="fc" id="L216">			log.info(&quot;Exception while connecting to database: {}&quot;, e.toString());</span>
		} finally {
<span class="nc" id="L218">			try {</span>
<span class="pc" id="L219">				stmtUpdate.close();</span>
<span class="pc" id="L220">				connection.close();</span>
<span class="pc" id="L221">			} catch (Exception e) {</span>
<span class="pc" id="L222">				log.info(&quot;Exception while closing connection to database: {}&quot;, e.toString());</span>
<span class="pc" id="L223">			}</span>
<span class="pc" id="L224">		}</span>
<span class="fc" id="L225">	}</span>

	
	/**
	*	Returns the value of a single column of the specified user from the userinfo table.
	*
	*	@param userId the user's Line ID.
	*	@param info the name of the column whose value is to be returned.
	*	@return the desired user info as a String.
	*/
	public String getUserInfo(String userId, String info) {
<span class="fc" id="L236">		Connection connection = null;</span>
<span class="fc" id="L237">		String queryString = null;</span>
<span class="fc" id="L238">		PreparedStatement stmtQuery = null;</span>
<span class="fc" id="L239">		ResultSet rs = null;</span>
<span class="fc" id="L240">		String result = null;</span>
		
		try {
<span class="fc" id="L243">			connection = this.getConnection();</span>
			
			// Returns user info if user exists
<span class="fc" id="L246">			queryString = &quot;SELECT &quot; + info + &quot; FROM userinfo WHERE userid = '&quot; + userId + &quot;'&quot;; </span>
<span class="fc" id="L247">			stmtQuery = connection.prepareStatement(queryString);</span>
<span class="fc" id="L248">			rs = stmtQuery.executeQuery();</span>
<span class="fc bfc" id="L249" title="All 4 branches covered.">			while (result == null &amp;&amp; rs.next()) {</span>
<span class="fc bfc" id="L250" title="All 2 branches covered.">				if (info.equals(&quot;age&quot;)) {</span>
<span class="fc" id="L251">					result = Integer.toString(rs.getInt(1));</span>

				}
<span class="fc bfc" id="L254" title="All 4 branches covered.">				else if (info.equals(&quot;height&quot;) || (info.equals(&quot;weight&quot;))) {</span>
<span class="fc" id="L255">					result = Double.toString(rs.getDouble(1));</span>
				}
				else {
<span class="fc" id="L258">					result = rs.getString(1);</span>
				}
			}
<span class="fc" id="L261">		} catch (Exception e) {</span>
<span class="fc" id="L262">			log.info(&quot;Exception while connecting to database: {}&quot;, e.toString());</span>
		} finally {
<span class="nc" id="L264">			try {</span>
<span class="pc" id="L265">				rs.close();</span>
<span class="pc" id="L266">				stmtQuery.close();</span>
<span class="pc" id="L267">				connection.close();</span>
<span class="pc" id="L268">			} catch (Exception e) {</span>
<span class="pc" id="L269">				log.info(&quot;Exception while closing connection to database: {}&quot;, e.toString());</span>
<span class="pc" id="L270">			}</span>
<span class="pc" id="L271">		}</span>
<span class="fc" id="L272">		return result;</span>
	}
	

	/**
	*	Sets the allergies for the specified user in the userallergies table.
	*
	*	@param userId the user's Line ID.
	*	@param allergies a list of the user's allergies.
	*/
	public void setUserAllergies(String userId, ArrayList&lt;String&gt; allergies) {
<span class="fc" id="L283">		Connection connection = null;</span>
<span class="fc" id="L284">		PreparedStatement stmtUpdate = null;</span>
<span class="fc" id="L285">		String statement = null;</span>
		
		try {
<span class="fc" id="L288">			connection = this.getConnection();</span>
			
			// Delete user allergies if it already exists
<span class="fc" id="L291">			stmtUpdate = connection.prepareStatement(</span>
				&quot;DELETE FROM userallergies &quot; +
				&quot;WHERE userId = ?&quot;
			);
<span class="fc" id="L295">			stmtUpdate.setString(1, userId);</span>
<span class="fc" id="L296">			stmtUpdate.executeUpdate();</span>

			// Insert user allergies into the database if they have any
<span class="fc bfc" id="L299" title="All 2 branches covered.">			if (allergies.size() != 0) {</span>
<span class="fc" id="L300">				stmtUpdate = connection.prepareStatement(</span>
					&quot;INSERT INTO userallergies &quot; +
					&quot;VALUES (?, ?)&quot;
				);
<span class="fc bfc" id="L304" title="All 2 branches covered.">				for (String allergy: allergies) {</span>
<span class="fc" id="L305">					stmtUpdate.setString(1, userId);</span>
<span class="fc" id="L306">					stmtUpdate.setString(2, allergy);</span>
<span class="fc" id="L307">					stmtUpdate.addBatch();						</span>
<span class="fc" id="L308">				}</span>
<span class="fc" id="L309">				stmtUpdate.executeBatch();</span>
			}
<span class="fc" id="L311">		} catch (Exception e) {</span>
<span class="fc" id="L312">			log.info(&quot;Exception while connecting to database: {}&quot;, e.toString());</span>
		} finally {
<span class="nc" id="L314">			try {</span>
<span class="pc" id="L315">				stmtUpdate.close();</span>
<span class="pc" id="L316">				connection.close();</span>
<span class="pc" id="L317">			} catch (Exception e) {</span>
<span class="pc" id="L318">				log.info(&quot;Exception while closing connection to database: {}&quot;, e.toString());</span>
<span class="pc" id="L319">			}</span>
<span class="pc" id="L320">		}</span>
<span class="fc" id="L321">	}</span>


	/**
	*	Returns the allergies for the specified user.
	*
	*	@param userId the user's Line ID.
	*	@return a list of the user's allergies.
	*/
	public ArrayList&lt;String&gt; getUserAllergies(String userId) {
<span class="fc" id="L331">		ArrayList&lt;String&gt; result = new ArrayList&lt;String&gt;();</span>
<span class="fc" id="L332">		Connection connection = null;</span>
<span class="fc" id="L333">		PreparedStatement stmtQuery = null;</span>
<span class="fc" id="L334">		ResultSet rs = null;</span>
		try {
<span class="fc" id="L336">			connection = this.getConnection();</span>

<span class="fc" id="L338">			stmtQuery = connection.prepareStatement(</span>
				&quot;SELECT allergy FROM userallergies &quot; +
				&quot;WHERE userid = ?&quot;
			);
<span class="fc" id="L342">			stmtQuery.setString(1, userId);</span>
<span class="fc" id="L343">			rs = stmtQuery.executeQuery(); </span>
<span class="fc bfc" id="L344" title="All 2 branches covered.">			while(rs.next()) {</span>
<span class="fc" id="L345">				result.add(rs.getString(1));</span>
			}
<span class="nc" id="L347">		} catch (Exception e) {</span>
<span class="nc" id="L348">			log.info(&quot;Exception while connecting to database: {}&quot;, e.toString());</span>
		} finally {
<span class="nc" id="L350">			try {</span>
<span class="pc" id="L351">				rs.close();</span>
<span class="pc" id="L352">				stmtQuery.close();</span>
<span class="pc" id="L353">				connection.close();</span>
<span class="nc" id="L354">			} catch (Exception ex) {</span>
<span class="nc" id="L355">				log.info(&quot;Exception while closing connection of database: {}&quot;, ex.toString());</span>
<span class="pc" id="L356">			}</span>
<span class="nc" id="L357">		}</span>
<span class="fc" id="L358">		return result;</span>
	}

	
	/**
	*	Deletes the specified user's info from the database.
	*	Deletes from both the userinfo and userallergies databases.
	*
	*	@param userId the user's Line ID.
	*/
	public void deleteUserInfo(String userId) {
<span class="fc" id="L369">		Connection connection = null;</span>
<span class="fc" id="L370">		PreparedStatement stmtDelete = null;</span>
		
		try {
<span class="fc" id="L373">			connection = this.getConnection();</span>
			
			// Delete user info if it already exists
<span class="fc" id="L376">			stmtDelete = connection.prepareStatement(</span>
				&quot;DELETE FROM userinfo &quot; +
				&quot;WHERE userId = ?&quot;
			);
<span class="fc" id="L380">			stmtDelete.setString(1, userId);</span>
<span class="fc" id="L381">			stmtDelete.executeUpdate();</span>

			// Delete user allergies if it already exists
<span class="fc" id="L384">			stmtDelete = connection.prepareStatement(</span>
				&quot;DELETE FROM userallergies &quot; +
				&quot;WHERE userId = ?&quot;
			);
<span class="fc" id="L388">			stmtDelete.setString(1, userId);</span>
<span class="fc" id="L389">			stmtDelete.executeUpdate();	</span>
<span class="nc" id="L390">		} catch (Exception e) {</span>
<span class="nc" id="L391">			log.info(&quot;Exception while connecting to database: {}&quot;, e.toString());</span>
		} finally {
<span class="nc" id="L393">			try {</span>
<span class="pc" id="L394">				stmtDelete.close();</span>
<span class="pc" id="L395">				connection.close();</span>
<span class="nc" id="L396">			} catch (Exception e) {</span>
<span class="nc" id="L397">				log.info(&quot;Exception while closing connection to database: {}&quot;, e.toString());</span>
<span class="pc" id="L398">			}</span>
<span class="nc" id="L399">		}</span>
<span class="fc" id="L400">	}</span>


	/**
	*	Adds meal name from the input menu into the meal table for the specified user.
	*
	*	@param userId the user's Line ID.
	*	@param menu a food menu.
	*/
	public void addMenu(String userId, ArrayList&lt;String&gt; menu) {
<span class="fc" id="L410">		Connection connection = null;</span>
<span class="fc" id="L411">		PreparedStatement stmtUpdate = null;</span>
		
		try {
<span class="fc" id="L414">			connection = this.getConnection();</span>
			
			// Insert meal names into menu table
<span class="fc" id="L417">			stmtUpdate = connection.prepareStatement(</span>
				&quot;INSERT INTO menu VALUES (?, ?)&quot;
			);
<span class="fc" id="L420">			stmtUpdate.setString(1, userId);</span>
<span class="fc bfc" id="L421" title="All 2 branches covered.">			for (String meal : menu) {</span>
<span class="fc" id="L422">				stmtUpdate.setString(2, meal);</span>
<span class="fc" id="L423">				stmtUpdate.addBatch();</span>
<span class="fc" id="L424">			}</span>
<span class="fc" id="L425">			stmtUpdate.executeBatch();</span>
<span class="fc" id="L426">		} catch (Exception e) {</span>
<span class="fc" id="L427">			log.info(&quot;Exception while connecting to database: {}&quot;, e.toString());</span>
		} finally {
<span class="nc" id="L429">			try {</span>
<span class="pc" id="L430">				stmtUpdate.close();</span>
<span class="pc" id="L431">				connection.close();</span>
<span class="pc" id="L432">			} catch (Exception e) {</span>
<span class="pc" id="L433">				log.info(&quot;Exception while closing connection to database: {}&quot;, e.toString());</span>
<span class="pc" id="L434">			}</span>
<span class="pc" id="L435">		}</span>
<span class="fc" id="L436">	}</span>
	
	
	/**
	*	Reads meal names from the meal table for the specified user, and matches them to the food in our food_type table.
	*	Stores the closes match for each meal name into the recommendation table for the specified user.
	*
	*	@param userId the user's Line ID.
	*/
	public void addRecommendations(String userId) {
<span class="fc" id="L446">		Connection connection = null;</span>
<span class="fc" id="L447">		PreparedStatement stmtUpdate = null;</span>
		
		try {
<span class="fc" id="L450">			connection = this.getConnection();</span>
			
			// Insert meal names into menu table
<span class="fc" id="L453">			stmtUpdate = connection.prepareStatement(</span>
				&quot;INSERT INTO recommendations &quot; +
				&quot;SELECT &quot; +
					&quot;DISTINCT ON (menu.meal_name) &quot; +
					&quot;userid, &quot; +
					&quot;menu.meal_name, &quot; +
					&quot;food_type.food, &quot; +
					&quot;food_type.type, &quot; +
					&quot;similarity(menu.meal_name, food_type.food) AS sim, &quot; +
					&quot;? AS weightage &quot; +
				&quot;FROM menu &quot; +
				&quot;JOIN food_type &quot; +
					&quot;ON similarity(menu.meal_name, food_type.food) &gt;= 0.2 &quot; +
					&quot;AND userid = ? &quot; +
				&quot;ORDER BY menu.meal_name, sim DESC&quot;
			);
<span class="fc" id="L469">			stmtUpdate.setDouble(1, 1.0);</span>
<span class="fc" id="L470">			stmtUpdate.setString(2, userId);</span>
<span class="fc" id="L471">			stmtUpdate.executeUpdate();</span>
<span class="nc" id="L472">		} catch (Exception e) {</span>
<span class="nc" id="L473">			log.info(&quot;Exception while connecting to database: {}&quot;, e.toString());</span>
		} finally {
<span class="nc" id="L475">			try {</span>
<span class="pc" id="L476">				stmtUpdate.close();</span>
<span class="pc" id="L477">				connection.close();</span>
<span class="nc" id="L478">			} catch (Exception e) {</span>
<span class="nc" id="L479">				log.info(&quot;Exception while closing connection to database: {}&quot;, e.toString());</span>
<span class="pc" id="L480">			}</span>
<span class="nc" id="L481">		}		</span>
<span class="fc" id="L482">	}</span>
	

	/**
	*	Removes recommendations from the recommendations table that the specified user is allergic to.
	*
	*	@param userId the user's Line ID.
	*/
	public void processRecommendationsByAllergies(String userId) {
<span class="fc" id="L491">		Connection connection = null;</span>
<span class="fc" id="L492">		PreparedStatement stmtQuery = null;</span>
<span class="fc" id="L493">		PreparedStatement stmtUpdate = null;</span>
<span class="fc" id="L494">		String update = null;</span>
<span class="fc" id="L495">		ResultSet rs = null;</span>
		
		try {
<span class="fc" id="L498">			connection = this.getConnection();</span>
			
			// Retrieves user allergies
<span class="fc" id="L501">			stmtQuery = connection.prepareStatement(</span>
				&quot;SELECT description &quot; +
				&quot;FROM ( &quot; +
					&quot;SELECT allergy &quot; +
					&quot;FROM userallergies &quot; +
					&quot;WHERE userid = ? &quot; +
				&quot;) AS UA &quot; +
				&quot;JOIN allergy_description &quot; +
					&quot;ON UA.allergy = allergy_description.allergy&quot;
			);
<span class="fc" id="L511">			stmtQuery.setString(1, userId);</span>
<span class="fc" id="L512">			rs = stmtQuery.executeQuery();</span>
			
			// Removes recommendations that the user is allergic to			
<span class="fc" id="L515">			stmtUpdate = connection.prepareStatement(</span>
				&quot;DELETE FROM recommendations &quot; + 
				&quot;WHERE description LIKE CONCAT('%', ?, '%')&quot;
			);
<span class="fc bfc" id="L519" title="All 2 branches covered.">			while (rs.next()) {							</span>
<span class="fc" id="L520">				stmtUpdate.setString(1, rs.getString(1));</span>
<span class="fc" id="L521">				stmtUpdate.addBatch();</span>
			}
<span class="fc" id="L523">			stmtUpdate.executeBatch();</span>
<span class="fc" id="L524">		} catch (Exception e) {</span>
<span class="fc" id="L525">			log.info(&quot;Exception while connecting to database: {}&quot;, e.toString());</span>
		} finally {
<span class="nc" id="L527">			try {</span>
<span class="pc" id="L528">				rs.close();</span>
<span class="pc" id="L529">				stmtQuery.close();</span>
<span class="pc" id="L530">				stmtUpdate.close();</span>
<span class="pc" id="L531">				connection.close();</span>
<span class="pc" id="L532">			} catch (Exception e) {</span>
<span class="pc" id="L533">				log.info(&quot;Exception while closing connection to database: {}&quot;, e.toString());</span>
<span class="pc" id="L534">			}</span>
<span class="pc" id="L535">		}</span>
<span class="fc" id="L536">	}</span>
	
	
	/**
	*	Adjusts the weightages of meals for the specified user in the recommendations table based on their recommended daily intake.
	*
	*	@param userId the user's Line ID.
	*/
	public void processRecommendationsByIntake(String userId) {
<span class="fc" id="L545">		Connection connection = null;</span>
<span class="fc" id="L546">		PreparedStatement stmtUpdate = null;</span>
		
		try {
<span class="fc" id="L549">			connection = this.getConnection();</span>
			
			// Adjusts the weightages of meals corresponsing to the user in the recommendations table
<span class="fc" id="L552">			stmtUpdate = connection.prepareStatement(</span>
				&quot;WITH daily_intake AS ( &quot; + 
					&quot;SELECT userinfo.userid, description, daily_serve &quot; + 
					&quot;FROM ( &quot; + 
						&quot;SELECT userid, description, food_type &quot; + 
						&quot;FROM recommendations &quot; + 
						&quot;WHERE userid = ? &quot; + 
					&quot;) AS R &quot; + 
					&quot;JOIN userinfo ON R.userid = userinfo.userid &quot; + 
					&quot;JOIN recommended_intake RI &quot; + 
						&quot;ON userinfo.age &gt;= RI.age_min &quot; + 
						&quot;AND userinfo.age &lt;= RI.age_max &quot; + 
						&quot;AND userinfo.gender = RI.gender &quot; + 
						&quot;AND R.food_type = RI.type &quot; + 
				&quot;) &quot; + 
				&quot;UPDATE recommendations &quot; + 
				&quot;SET weightage = daily_intake.daily_serve &quot; + 
				&quot;FROM daily_intake &quot; + 
				&quot;WHERE recommendations.description = daily_intake.description &quot; +
				&quot;AND recommendations.userid = daily_intake.userid&quot;
			);
<span class="fc" id="L573">			stmtUpdate.setString(1, userId);</span>
<span class="fc" id="L574">			stmtUpdate.executeUpdate();</span>
<span class="nc" id="L575">		} catch (Exception e) {</span>
<span class="nc" id="L576">			log.info(&quot;Exception while connecting to database: {}&quot;, e.toString());</span>
		} finally {
<span class="nc" id="L578">			try {</span>
<span class="pc" id="L579">				stmtUpdate.close();</span>
<span class="pc" id="L580">				connection.close();</span>
<span class="nc" id="L581">			} catch (Exception e) {</span>
<span class="nc" id="L582">				log.info(&quot;Exception while closing connection to database: {}&quot;, e.toString());</span>
<span class="pc" id="L583">			}</span>
<span class="nc" id="L584">		}</span>
<span class="fc" id="L585">	}</span>


	/**
	*	Adjusts the weightages of meals for the specified user in the recommendations table based on their eating history.
	*
	*	@param userId the user's Line ID.
	*/
	public void processRecommendationsByEatingHistory(String userId) {
<span class="fc" id="L594">		Connection connection = null;</span>
<span class="fc" id="L595">		ArrayList&lt;String&gt; foods = new ArrayList&lt;String&gt;();</span>
<span class="fc" id="L596">		PreparedStatement stmtQuery = null;</span>
<span class="fc" id="L597">		PreparedStatement stmtUpdate = null;</span>
<span class="fc" id="L598">		ResultSet rs = null;</span>

		try {
<span class="fc" id="L601">			connection = this.getConnection();</span>
			
			// Collects the foods that the user has eaten in the past 2 days
<span class="fc" id="L604">			stmtQuery = connection.prepareStatement(</span>
				&quot;SELECT description &quot; +
				&quot;FROM eating_history &quot; +
				&quot;WHERE userid = ? &quot; +
					&quot;AND date &gt;= CURRENT_DATE - 2&quot;
			);
<span class="fc" id="L610">			stmtQuery.setString(1, userId);</span>
<span class="fc" id="L611">			rs = stmtQuery.executeQuery();</span>
<span class="fc bfc" id="L612" title="All 2 branches covered.">			while (rs.next()) {</span>
<span class="fc bfc" id="L613" title="All 2 branches covered.">				for (String food: rs.getString(1).split(&quot;,&quot;)) {</span>
<span class="fc" id="L614">					foods.add(food);</span>
				}
			}

			// Adjusts the weightages of meals of the user in the recommendations table based on the collected foods
<span class="fc" id="L619">			stmtUpdate = connection.prepareStatement(</span>
				&quot;UPDATE recommendations &quot; + 
				&quot;SET weightage = weightage * 0.5 &quot; + 
				&quot;WHERE recommendations.description = ? &quot; +
				&quot;AND recommendations.userid = ?&quot;
			);
<span class="fc" id="L625">			stmtUpdate.setString(2, userId);</span>
<span class="fc bfc" id="L626" title="All 2 branches covered.">			for (String food: foods) {</span>
<span class="fc" id="L627">				stmtUpdate.setString(1, food);</span>
<span class="fc" id="L628">				stmtUpdate.addBatch();</span>
<span class="fc" id="L629">			}</span>
<span class="fc" id="L630">			stmtUpdate.executeBatch();</span>
<span class="nc" id="L631">		} catch (Exception e) {</span>
<span class="nc" id="L632">			log.info(&quot;Exception while connecting to database: {}&quot;, e.toString());</span>
		} finally {
<span class="nc" id="L634">			try {</span>
<span class="pc" id="L635">				rs.close();</span>
<span class="pc" id="L636">				stmtQuery.close();</span>
<span class="pc" id="L637">				stmtUpdate.close();</span>
<span class="pc" id="L638">				connection.close();</span>
<span class="nc" id="L639">			} catch (Exception e) {</span>
<span class="nc" id="L640">				log.info(&quot;Exception while closing connection to database: {}&quot;, e.toString());</span>
<span class="pc" id="L641">			}</span>
<span class="nc" id="L642">		}</span>
<span class="fc" id="L643">	}</span>


	/**
	*	Adjusts the weightages of meals for the specified user in the recommendations table based on their dieting goals.
	*
	*	@param userId the user's Line ID.
	*/
	public void processRecommendationsByGoal(String userId) {
<span class="fc" id="L652">		Connection connection = null;</span>
<span class="fc" id="L653">		String diet = null;</span>
<span class="fc" id="L654">		PreparedStatement stmtQuery = null;</span>
<span class="fc" id="L655">		PreparedStatement stmtUpdate = null;</span>
<span class="fc" id="L656">		ResultSet rs = null;</span>
		
		try {
<span class="fc" id="L659">			connection = this.getConnection();</span>
			
			// Retrieves the user's dieting goals
<span class="fc" id="L662">			stmtQuery = connection.prepareStatement(</span>
				&quot;SELECT diet &quot; +
				&quot;FROM userinfo &quot; +
				&quot;WHERE userid = ?&quot;
			);
<span class="fc" id="L667">			stmtQuery.setString(1, userId);</span>
<span class="fc" id="L668">			rs = stmtQuery.executeQuery();</span>
<span class="fc bfc" id="L669" title="All 2 branches covered.">			while (rs.next()) {</span>
<span class="fc" id="L670">				diet = rs.getString(1);</span>
			}

			// Adjusts the weightages of meals of the user in the recommendations table based on the user's dieting goals, if their diet is not &quot;normal&quot;
<span class="fc bfc" id="L674" title="All 2 branches covered.">			if (!diet.equals(&quot;normal&quot;)) {</span>
<span class="fc" id="L675">				stmtUpdate = connection.prepareStatement(</span>
					&quot;UPDATE recommendations R &quot; + 
					&quot;SET weightage = R.weightage * FDW.weightage &quot; + 
					&quot;FROM food_diet_weightage FDW &quot; +
					&quot;WHERE FDW.diet = ? &quot; +
						&quot;AND R.userid = ? &quot; +
						&quot;AND R.food_type = FDW.food&quot;
				);
<span class="fc" id="L683">				stmtUpdate.setString(1, diet);</span>
<span class="fc" id="L684">				stmtUpdate.setString(2, userId);</span>
<span class="fc" id="L685">				stmtUpdate.executeUpdate();</span>
			}
<span class="fc" id="L687">		} catch (Exception e) {</span>
<span class="fc" id="L688">			log.info(&quot;Exception while connecting to database: {}&quot;, e.toString());</span>
		} finally {
<span class="nc" id="L690">			try {</span>
<span class="pc" id="L691">				rs.close();</span>
<span class="pc" id="L692">				stmtQuery.close();</span>
<span class="pc" id="L693">				stmtUpdate.close();</span>
<span class="pc" id="L694">				connection.close();</span>
<span class="pc" id="L695">			} catch (Exception e) {</span>
<span class="pc" id="L696">				log.info(&quot;Exception while closing connection to database: {}&quot;, e.toString());</span>
<span class="pc" id="L697">			}</span>
<span class="fc" id="L698">		}</span>
<span class="fc" id="L699">	}	</span>
	
	
	/**
	*	Returns a HashMap of meal recommendations for the specified user.
	*
	*	@param userId the user's Line ID.
	*/
	public HashMap&lt;String, Double&gt; getRecommendationList(String userId) {
<span class="fc" id="L708">		Connection connection = null;</span>
<span class="fc" id="L709">		PreparedStatement stmtQuery = null;</span>
<span class="fc" id="L710">		ResultSet rs = null;</span>
<span class="fc" id="L711">		HashMap&lt;String, Double&gt; foodWeightage = new HashMap&lt;String, Double&gt;();</span>
<span class="fc" id="L712">		String food = null;</span>
<span class="fc" id="L713">		double weightage = 0;</span>
		
		try {
<span class="fc" id="L716">			connection = this.getConnection();</span>
			
			// Retrieves meal name and weightage to be put into the HashMap
<span class="fc" id="L719">			stmtQuery = connection.prepareStatement(</span>
				&quot;SELECT meal_name, weightage &quot; + 
				&quot;FROM recommendations &quot; + 
				&quot;WHERE userid = ?&quot;
			);
<span class="fc" id="L724">			stmtQuery.setString(1, userId);</span>
<span class="fc" id="L725">			rs = stmtQuery.executeQuery();</span>
<span class="fc bfc" id="L726" title="All 2 branches covered.">			while (rs.next()) {</span>
<span class="fc" id="L727">				food = rs.getString(1);</span>
<span class="fc" id="L728">				weightage = rs.getDouble(2);</span>
<span class="fc" id="L729">				foodWeightage.put(food, weightage);</span>
			}
<span class="nc" id="L731">		} catch (Exception e) {</span>
<span class="nc" id="L732">			log.info(&quot;Exception while connecting to database: {}&quot;, e.toString());</span>
		} finally {
<span class="nc" id="L734">			try {</span>
<span class="pc" id="L735">				rs.close();</span>
<span class="pc" id="L736">				stmtQuery.close();</span>
<span class="pc" id="L737">				connection.close();</span>
<span class="nc" id="L738">			} catch (Exception e) {</span>
<span class="nc" id="L739">				log.info(&quot;Exception while closing connection to database: {}&quot;, e.toString());</span>
<span class="pc" id="L740">			}</span>
<span class="nc" id="L741">		}</span>
<span class="fc" id="L742">		return foodWeightage;</span>
	}
	
	
	/**
	*	Determines if the specified user is stored within the input table.
	*
	*	@param userId the user's Line ID.
	*	@param table the name of the table where you want to search for the user.
	*	@return true if the specified user exists within the table; false otherwise.
	*/
	public boolean searchUser(String userId, String table) {
<span class="fc" id="L754">		String result = null;</span>
<span class="fc" id="L755">		Connection connection = null;</span>
<span class="fc" id="L756">		PreparedStatement stmtQuery = null;</span>
<span class="fc" id="L757">		String statement = null;</span>
<span class="fc" id="L758">		ResultSet rs = null;</span>
		try {
<span class="fc" id="L760">			connection = this.getConnection();</span>

<span class="fc" id="L762">			statement = &quot;SELECT userid FROM &quot; + table + &quot; WHERE userid = ?&quot;;</span>
<span class="fc" id="L763">			stmtQuery = connection.prepareStatement(statement);</span>
<span class="fc" id="L764">			stmtQuery.setString(1, userId);</span>
<span class="fc" id="L765">			rs = stmtQuery.executeQuery(); </span>
<span class="fc bfc" id="L766" title="All 4 branches covered.">			while(result == null &amp;&amp; rs.next()) {</span>
<span class="fc" id="L767">				result = rs.getString(1);</span>
			}
<span class="fc" id="L769">		} catch (Exception e) {</span>
<span class="fc" id="L770">			log.info(&quot;Exception while connecting to database: {}&quot;, e.toString());</span>
		} finally {
<span class="nc" id="L772">			try {</span>
<span class="pc" id="L773">				rs.close();</span>
<span class="pc" id="L774">				stmtQuery.close();</span>
<span class="pc" id="L775">				connection.close();</span>
<span class="pc" id="L776">			} catch (Exception ex) {</span>
<span class="pc" id="L777">				log.info(&quot;Exception while closing connection of database: {}&quot;, ex.toString());</span>
<span class="pc" id="L778">			}</span>
<span class="pc" id="L779">		}</span>
<span class="fc bfc" id="L780" title="All 2 branches covered.">		if (result != null) {return true;}</span>
<span class="fc" id="L781">		else {return false;}</span>
	}


	/**
	*	Gets the input meal from the menu table for the specified user.
	*	Used for debugging and testing purposes.
	*
	*	@param userId the user's Line ID.
	*	@param text the name of the meal.
	*	@return the meal name if exists within the table; null otherwise.
	*/
	public String getMenu(String userId, String text) {
<span class="fc" id="L794">		String result = null;</span>
<span class="fc" id="L795">		Connection connection = null;</span>
<span class="fc" id="L796">		PreparedStatement stmtQuery = null;</span>
<span class="fc" id="L797">		ResultSet rs = null;</span>
		try {
<span class="fc" id="L799">			connection = this.getConnection();</span>

<span class="fc" id="L801">			stmtQuery = connection.prepareStatement(</span>
				&quot;SELECT meal_name FROM menu &quot; +
				&quot;WHERE userid = ? &quot; +
					&quot;AND meal_name LIKE CONCAT('%', ?, '%')&quot;
			);
<span class="fc" id="L806">			stmtQuery.setString(1, userId);</span>
<span class="fc" id="L807">			stmtQuery.setString(2, text);</span>
<span class="fc" id="L808">			rs = stmtQuery.executeQuery(); </span>
<span class="fc bfc" id="L809" title="All 4 branches covered.">			while(result == null &amp;&amp; rs.next()) {</span>
<span class="fc" id="L810">				result = rs.getString(1);</span>
			}
<span class="nc" id="L812">		} catch (Exception e) {</span>
<span class="nc" id="L813">			log.info(&quot;Exception while connecting to database: {}&quot;, e.toString());</span>
		} finally {
<span class="nc" id="L815">			try {</span>
<span class="pc" id="L816">				rs.close();</span>
<span class="pc" id="L817">				stmtQuery.close();</span>
<span class="pc" id="L818">				connection.close();</span>
<span class="nc" id="L819">			} catch (Exception ex) {</span>
<span class="nc" id="L820">				log.info(&quot;Exception while closing connection of database: {}&quot;, ex.toString());</span>
<span class="pc" id="L821">			}</span>
<span class="nc" id="L822">		}</span>
<span class="fc" id="L823">		return result;</span>
	}
	

	/**
	*	Gets the input meal from the recommendations table for the specified user.
	*	Used for debugging and testing purposes.
	*
	*	@param userId the user's Line ID.
	*	@param text the name of the meal.
	*	@return the meal name if exists within the table; null otherwise.
	*/
	public String getRecommendation(String userId, String text) {
		//Write your code here
<span class="fc" id="L837">		String result = null;</span>
<span class="fc" id="L838">		Connection connection = null;</span>
<span class="fc" id="L839">		PreparedStatement stmtQuery = null;</span>
<span class="fc" id="L840">		ResultSet rs = null;</span>
		try {
<span class="fc" id="L842">			connection = this.getConnection();</span>

<span class="fc" id="L844">			stmtQuery = connection.prepareStatement(</span>
				&quot;SELECT meal_name FROM recommendations &quot; +
				&quot;WHERE userid = ? &quot; +
					&quot;AND meal_name LIKE CONCAT('%', ?, '%')&quot;
			);
<span class="fc" id="L849">			stmtQuery.setString(1, userId);</span>
<span class="fc" id="L850">			stmtQuery.setString(2, text);</span>
<span class="fc" id="L851">			rs = stmtQuery.executeQuery(); </span>
<span class="fc bfc" id="L852" title="All 4 branches covered.">			while(result == null &amp;&amp; rs.next()) {</span>
<span class="fc" id="L853">				result = rs.getString(1);</span>
			}
<span class="nc" id="L855">		} catch (Exception e) {</span>
<span class="nc" id="L856">			log.info(&quot;Exception while connecting to database: {}&quot;, e.toString());</span>
		} finally {
<span class="nc" id="L858">			try {</span>
<span class="pc" id="L859">				rs.close();</span>
<span class="pc" id="L860">				stmtQuery.close();</span>
<span class="pc" id="L861">				connection.close();</span>
<span class="nc" id="L862">			} catch (Exception ex) {</span>
<span class="nc" id="L863">				log.info(&quot;Exception while closing connection of database: {}&quot;, ex.toString());</span>
<span class="pc" id="L864">			}</span>
<span class="nc" id="L865">		}</span>
<span class="fc" id="L866">		return result;</span>
	}


	/**
	*	Gets the weightage of the input meal from the menu table for the specified user.
	*	Used for debugging and testing purposes.
	*
	*	@param userId the user's Line ID.
	*	@param text the name of the meal.
	*	@return the weightage of the meal if exists within the table; null otherwise.
	*/
	public double getWeightage(String userId, String text) {
		//Write your code here
<span class="fc" id="L880">		double result = -1;</span>
<span class="fc" id="L881">		Connection connection = null;</span>
<span class="fc" id="L882">		PreparedStatement stmtQuery = null;</span>
<span class="fc" id="L883">		ResultSet rs = null;</span>
		try {
<span class="fc" id="L885">			connection = this.getConnection();</span>

<span class="fc" id="L887">			stmtQuery = connection.prepareStatement(</span>
				&quot;SELECT weightage FROM recommendations &quot; +
				&quot;WHERE userid = ? &quot; +
					&quot;AND meal_name LIKE CONCAT('%', ?, '%')&quot;
			);
<span class="fc" id="L892">			stmtQuery.setString(1, userId);</span>
<span class="fc" id="L893">			stmtQuery.setString(2, text);</span>
<span class="fc" id="L894">			rs = stmtQuery.executeQuery(); </span>
<span class="fc bfc" id="L895" title="All 4 branches covered.">			while(result == -1 &amp;&amp; rs.next()) {</span>
<span class="fc" id="L896">				result = rs.getDouble(1);</span>
			}
<span class="nc" id="L898">		} catch (Exception e) {</span>
<span class="nc" id="L899">			log.info(&quot;Exception while connecting to database: {}&quot;, e.toString());</span>
		} finally {
<span class="nc" id="L901">			try {</span>
<span class="pc" id="L902">				rs.close();</span>
<span class="pc" id="L903">				stmtQuery.close();</span>
<span class="pc" id="L904">				connection.close();</span>
<span class="nc" id="L905">			} catch (Exception ex) {</span>
<span class="nc" id="L906">				log.info(&quot;Exception while closing connection of database: {}&quot;, ex.toString());</span>
<span class="pc" id="L907">			}</span>
<span class="nc" id="L908">		}</span>
<span class="fc" id="L909">		return result;</span>
	}


	/**
	*	Adds the specified user into the campaign_user table.
	*
	*	@param userId the user's Line ID.
	*/
	public void addCampaignUser(String userId) {
<span class="fc" id="L919">		Connection connection = null;</span>
<span class="fc" id="L920">		PreparedStatement stmtUpdate = null;</span>
		
		try {
<span class="fc" id="L923">			connection = this.getConnection();</span>
			
<span class="fc" id="L925">			stmtUpdate = connection.prepareStatement(</span>
				&quot;INSERT INTO campaign_user &quot; +
				&quot;VALUES (?)&quot;
			);
<span class="fc" id="L929">			stmtUpdate.setString(1, userId);</span>
<span class="fc" id="L930">			stmtUpdate.executeUpdate();</span>
<span class="nc" id="L931">		} catch (Exception e) {</span>
<span class="nc" id="L932">			log.info(&quot;Exception while connecting to database: {}&quot;, e.toString());</span>
		} finally {
<span class="nc" id="L934">			try {</span>
<span class="pc" id="L935">				stmtUpdate.close();</span>
<span class="pc" id="L936">				connection.close();</span>
<span class="nc" id="L937">			} catch (Exception e) {</span>
<span class="nc" id="L938">				log.info(&quot;Exception while closing connection to database: {}&quot;, e.toString());</span>
<span class="pc" id="L939">			}</span>
<span class="nc" id="L940">		}	</span>
<span class="fc" id="L941">	}</span>


	/**
	*	Generates and stores a unique 6-digit code in the coupon_code database, together with the userId of the user who requested it.
	*
	*	@param userId the user's Line ID.
	*	@return the generated code.
	*/
	public int generateAndStoreCode(String userId) {
<span class="fc" id="L951">		int result = -1;</span>
<span class="fc" id="L952">		Connection connection = null;</span>
<span class="fc" id="L953">		PreparedStatement stmtUpdate = null;</span>
<span class="fc" id="L954">		PreparedStatement stmtQuery = null;</span>
<span class="fc" id="L955">		ResultSet rs = null;</span>
		
		try {
<span class="fc" id="L958">			connection = this.getConnection();</span>

			// Generate and insert the code into the coupon_code database, together with the userId
<span class="fc" id="L961">			stmtQuery = connection.prepareStatement(</span>
				&quot;SELECT count(*)+100000 &quot; +
				&quot;FROM coupon_code;&quot;
			);
<span class="fc" id="L965">			rs = stmtQuery.executeQuery(); </span>
<span class="pc bpc" id="L966" title="1 of 4 branches missed.">			while(result == -1 &amp;&amp; rs.next()) {</span>
<span class="fc" id="L967">				result = (rs.getInt(1));</span>
			}

<span class="fc" id="L970">			stmtUpdate = connection.prepareStatement(</span>
				&quot;INSERT INTO coupon_code &quot; +
				&quot;VALUES (?, ?)&quot;
			);
<span class="fc" id="L974">			stmtUpdate.setInt(1, result);</span>
<span class="fc" id="L975">			stmtUpdate.setString(2, userId);</span>
<span class="fc" id="L976">			stmtUpdate.executeUpdate();</span>
<span class="fc" id="L977">		} catch (Exception e) {</span>
<span class="fc" id="L978">			log.info(&quot;Exception while connecting to database: {}&quot;, e.toString());</span>
		} finally {
<span class="nc" id="L980">			try {</span>
<span class="pc" id="L981">				rs.close();</span>
<span class="pc" id="L982">				stmtQuery.close();</span>
<span class="pc" id="L983">				stmtUpdate.close();</span>
<span class="pc" id="L984">				connection.close();</span>
<span class="pc" id="L985">			} catch (Exception e) {</span>
<span class="pc" id="L986">				log.info(&quot;Exception while closing connection to database: {}&quot;, e.toString());</span>
<span class="pc" id="L987">			}</span>
<span class="pc" id="L988">		}</span>
<span class="fc" id="L989">		return result;</span>
	}


	/**
	*	Sets the value of the claimuser column with corresponding code to the input userId in the coupon_code table.
	*
	*	@param userId the user's Line ID.
	*	@param code the code to be claimed.
	*/
	public void claimCode(String userId, int code) {
<span class="fc" id="L1000">		Connection connection = null;</span>
<span class="fc" id="L1001">		PreparedStatement stmtUpdate = null;</span>

		try {
<span class="fc" id="L1004">			connection = this.getConnection();</span>
			// Set claimUser of code to be userId
<span class="fc" id="L1006">			stmtUpdate = connection.prepareStatement(</span>
				&quot;UPDATE coupon_code &quot; +
				&quot;SET claimuser = ? &quot; +
				&quot;WHERE code = ?&quot;
			);
<span class="fc" id="L1011">			stmtUpdate.setString(1, userId);</span>
<span class="fc" id="L1012">			stmtUpdate.setInt(2, code);</span>
<span class="fc" id="L1013">			stmtUpdate.executeUpdate();</span>

			// Delete userId from campaignUser table
<span class="fc" id="L1016">			stmtUpdate = connection.prepareStatement(</span>
				&quot;DELETE FROM campaign_user &quot; +
				&quot;WHERE userid = ?&quot;
			);
<span class="fc" id="L1020">			stmtUpdate.setString(1, userId);</span>
<span class="fc" id="L1021">			stmtUpdate.executeUpdate();</span>
<span class="nc" id="L1022">		} catch (Exception e) {</span>
<span class="nc" id="L1023">			log.info(&quot;Exception while connecting to database: {}&quot;, e.toString());</span>
		} finally {
<span class="nc" id="L1025">			try {</span>
<span class="pc" id="L1026">				stmtUpdate.close();</span>
<span class="pc" id="L1027">				connection.close();</span>
<span class="nc" id="L1028">			} catch (Exception e) {</span>
<span class="nc" id="L1029">				log.info(&quot;Exception while closing connection to database: {}&quot;, e.toString());</span>
<span class="pc" id="L1030">			}</span>
<span class="nc" id="L1031">		}</span>
<span class="fc" id="L1032">	}</span>


	/**
	*	Gets the requestuser and claimuser values for the specified code.
	*
	*	@param code a coupon code.
	*	@return a list of strings, where the first element is the requestuser, and the second element is the claimuser.
	*/
	public ArrayList&lt;String&gt; getCodeInfo(int code) {
<span class="fc" id="L1042">		ArrayList&lt;String&gt; result = new ArrayList&lt;String&gt;();</span>
<span class="fc" id="L1043">		Connection connection = null;</span>
<span class="fc" id="L1044">		PreparedStatement stmtQuery = null;</span>
<span class="fc" id="L1045">		ResultSet rs = null;</span>
		try {
<span class="fc" id="L1047">			connection = this.getConnection();</span>

<span class="fc" id="L1049">			stmtQuery = connection.prepareStatement(</span>
				&quot;SELECT requestuser, claimuser &quot; +
				&quot;FROM coupon_code &quot; +
				&quot;WHERE code = ?&quot;
			);
<span class="fc" id="L1054">			stmtQuery.setInt(1, code);</span>
<span class="fc" id="L1055">			rs = stmtQuery.executeQuery(); </span>
<span class="fc bfc" id="L1056" title="All 4 branches covered.">			while(result.size() &lt;= 0 &amp;&amp; rs.next()) {</span>
<span class="fc" id="L1057">				result.add(rs.getString(1));</span>
<span class="fc" id="L1058">				result.add(rs.getString(2));</span>
			}
<span class="nc" id="L1060">		} catch (Exception e) {</span>
<span class="nc" id="L1061">			log.info(&quot;Exception while connecting to database: {}&quot;, e.toString());</span>
		} finally {
<span class="nc" id="L1063">			try {</span>
<span class="pc" id="L1064">				rs.close();</span>
<span class="pc" id="L1065">				stmtQuery.close();</span>
<span class="pc" id="L1066">				connection.close();</span>
<span class="nc" id="L1067">			} catch (Exception ex) {</span>
<span class="nc" id="L1068">				log.info(&quot;Exception while closing connection of database: {}&quot;, ex.toString());</span>
<span class="pc" id="L1069">			}</span>
<span class="nc" id="L1070">		}</span>
<span class="fc" id="L1071">		return result;</span>
	}


	/**
	*	Determines if they are already 5000 claimed coupons.
	*
	*	@param limit should be 5000. This parameter is added for testing purposes.
	*	@return true if there are &gt;= 5000 claimed coupons; false otherwise.
	*/
	public boolean couponExceeds5000(int limit) {
<span class="fc" id="L1082">		boolean result = true;</span>
<span class="fc" id="L1083">		Connection connection = null;</span>
<span class="fc" id="L1084">		PreparedStatement stmtUpdate = null;</span>
<span class="fc" id="L1085">		PreparedStatement stmtQuery = null;</span>
<span class="fc" id="L1086">		ResultSet rs = null;</span>
		
		try {
<span class="fc" id="L1089">			connection = this.getConnection();</span>

<span class="fc" id="L1091">			stmtQuery = connection.prepareStatement(</span>
				&quot;SELECT count(claimuser) * 2 &quot; +
				&quot;FROM coupon_code;&quot;
			);
<span class="fc" id="L1095">			rs = stmtQuery.executeQuery(); </span>
<span class="fc bfc" id="L1096" title="All 2 branches covered.">			while(rs.next()) {</span>
<span class="fc bfc" id="L1097" title="All 2 branches covered.">				if (rs.getInt(1) &gt;= limit) {result = true;}</span>
<span class="fc" id="L1098">				else {result = false;}</span>
			}
<span class="nc" id="L1100">		} catch (Exception e) {</span>
<span class="nc" id="L1101">			log.info(&quot;Exception while connecting to database: {}&quot;, e.toString());</span>
		} finally {
<span class="nc" id="L1103">			try {</span>
<span class="pc" id="L1104">				rs.close();</span>
<span class="pc" id="L1105">				stmtQuery.close();</span>
<span class="nc" id="L1106">				stmtUpdate.close();</span>
<span class="nc" id="L1107">				connection.close();</span>
<span class="pc" id="L1108">			} catch (Exception e) {</span>
<span class="pc" id="L1109">				log.info(&quot;Exception while closing connection to database: {}&quot;, e.toString());</span>
<span class="nc" id="L1110">			}</span>
<span class="pc" id="L1111">		}</span>
<span class="fc" id="L1112">		return result;</span>
	}	


	/**
	*	Sets the url in the coupon_url database
	*
	*	@param url a coupon url.
	*/
	public void setCouponUrl(String url) {
<span class="fc" id="L1122">		Connection connection = null;</span>
<span class="fc" id="L1123">		PreparedStatement stmtUpdate = null;</span>
<span class="fc" id="L1124">		String statement = null;</span>
		
		try {
<span class="fc" id="L1127">			connection = this.getConnection();</span>
			
			// Delete url if it already exists
<span class="fc" id="L1130">			stmtUpdate = connection.prepareStatement(</span>
				&quot;DELETE FROM coupon_url&quot;
			);
<span class="fc" id="L1133">			stmtUpdate.executeUpdate();</span>

			// Insert coupon url into database
<span class="fc" id="L1136">			stmtUpdate = connection.prepareStatement(</span>
				&quot;INSERT INTO coupon_url &quot; +
				&quot;VALUES (?)&quot;
			);
<span class="fc" id="L1140">			stmtUpdate.setString(1, url);</span>
<span class="fc" id="L1141">			stmtUpdate.executeUpdate();</span>
<span class="nc" id="L1142">		} catch (Exception e) {</span>
<span class="nc" id="L1143">			log.info(&quot;Exception while connecting to database: {}&quot;, e.toString());</span>
		} finally {
<span class="nc" id="L1145">			try {</span>
<span class="pc" id="L1146">				stmtUpdate.close();</span>
<span class="pc" id="L1147">				connection.close();</span>
<span class="nc" id="L1148">			} catch (Exception e) {</span>
<span class="nc" id="L1149">				log.info(&quot;Exception while closing connection to database: {}&quot;, e.toString());</span>
<span class="pc" id="L1150">			}</span>
<span class="nc" id="L1151">		}</span>
<span class="fc" id="L1152">	}</span>


	/**
	*	Returns the coupon url from the coupon_url database
	*
	*	@return the coupon url.
	*/
	public String getCouponUrl() {
<span class="fc" id="L1161">		String result = null;</span>
<span class="fc" id="L1162">		Connection connection = null;</span>
<span class="fc" id="L1163">		PreparedStatement stmtQuery = null;</span>
<span class="fc" id="L1164">		ResultSet rs = null;</span>
		try {
<span class="fc" id="L1166">			connection = this.getConnection();</span>

<span class="fc" id="L1168">			stmtQuery = connection.prepareStatement(</span>
				&quot;SELECT url &quot; +
				&quot;FROM coupon_url&quot;
			);
<span class="fc" id="L1172">			rs = stmtQuery.executeQuery(); </span>
<span class="pc bpc" id="L1173" title="1 of 4 branches missed.">			while(result == null &amp;&amp; rs.next()) {</span>
<span class="fc" id="L1174">				result = rs.getString(1);</span>
			}
<span class="nc" id="L1176">		} catch (Exception e) {</span>
<span class="nc" id="L1177">			log.info(&quot;Exception while connecting to database: {}&quot;, e.toString());</span>
		} finally {
<span class="nc" id="L1179">			try {</span>
<span class="pc" id="L1180">				rs.close();</span>
<span class="pc" id="L1181">				stmtQuery.close();</span>
<span class="pc" id="L1182">				connection.close();</span>
<span class="nc" id="L1183">			} catch (Exception ex) {</span>
<span class="nc" id="L1184">				log.info(&quot;Exception while closing connection of database: {}&quot;, ex.toString());</span>
<span class="pc" id="L1185">			}</span>
<span class="nc" id="L1186">		}</span>
<span class="fc" id="L1187">		return result;</span>
	}


	/**
	*	Adds the input meals to the specified user's eating history
	*
	*	@param userId the user's Line ID.
	*	@param meals meals that the user has eaten.
	*/
	public void addUserEatingHistory(String userId, String meals) {
<span class="fc" id="L1198">		String[] mealList = meals.split(&quot;,&quot;);</span>
<span class="fc" id="L1199">		StringJoiner foodJoiner = new StringJoiner(&quot;,&quot;);</span>
<span class="fc" id="L1200">		StringJoiner typeJoiner = new StringJoiner(&quot;,&quot;);</span>
<span class="fc" id="L1201">		Connection connection = null;</span>
<span class="fc" id="L1202">		PreparedStatement stmtQuery = null;</span>
<span class="fc" id="L1203">		PreparedStatement stmtUpdate = null;</span>
<span class="fc" id="L1204">		ResultSet rs = null;</span>
		
		try {
<span class="fc" id="L1207">			connection = this.getConnection();</span>

<span class="fc" id="L1209">			stmtQuery = connection.prepareStatement(</span>
				&quot;SELECT &quot; +
					&quot;DISTINCT ON (meal_name) &quot; +
					&quot;food, &quot; +
					&quot;type, &quot; +
					&quot;? AS meal_name, &quot; +
					&quot;similarity(?, food_type.food) AS sim &quot; +
				&quot;FROM food_type &quot; +
				&quot;ORDER BY meal_name, sim DESC&quot;
			);
<span class="fc bfc" id="L1219" title="All 2 branches covered.">			for (String meal: mealList) {</span>
<span class="fc" id="L1220">				stmtQuery.setString(1, meal);</span>
<span class="fc" id="L1221">				stmtQuery.setString(2, meal);</span>
<span class="fc" id="L1222">				rs = stmtQuery.executeQuery();</span>
<span class="fc bfc" id="L1223" title="All 2 branches covered.">				while(rs.next()) {</span>
<span class="fc" id="L1224">					foodJoiner.add(rs.getString(1));</span>
<span class="fc" id="L1225">					typeJoiner.add(rs.getString(2));</span>
				}
			}

<span class="fc" id="L1229">			stmtUpdate = connection.prepareStatement(</span>
				&quot;INSERT INTO eating_history &quot; +
				&quot;VALUES (?, ?, ?, ?, CURRENT_DATE)&quot;
			);
<span class="fc" id="L1233">			stmtUpdate.setString(1, userId);</span>
<span class="fc" id="L1234">			stmtUpdate.setString(2, meals);</span>
<span class="fc" id="L1235">			stmtUpdate.setString(3, foodJoiner.toString());</span>
<span class="fc" id="L1236">			stmtUpdate.setString(4, typeJoiner.toString());</span>
<span class="fc" id="L1237">			stmtUpdate.executeUpdate();</span>
<span class="nc" id="L1238">		} catch (Exception e) {</span>
<span class="nc" id="L1239">			log.info(&quot;Exception while connecting to database: {}&quot;, e.toString());</span>
		} finally {
<span class="nc" id="L1241">			try {</span>
<span class="pc" id="L1242">				rs.close();</span>
<span class="pc" id="L1243">				stmtQuery.close();</span>
<span class="pc" id="L1244">				stmtUpdate.close();</span>
<span class="pc" id="L1245">				connection.close();</span>
<span class="nc" id="L1246">			} catch (Exception e) {</span>
<span class="nc" id="L1247">				log.info(&quot;Exception while closing connection to database: {}&quot;, e.toString());</span>
<span class="pc" id="L1248">			}</span>
<span class="nc" id="L1249">		}	</span>
<span class="fc" id="L1250">	}</span>


	/**
	*	Gets the user's eating history for the past input number of days
	*	Used for debugging and testing purposes.
	*
	*	@param userId the user's Line ID.
	*	@param days the number of days of eating history to be retrieved.
	*/
	public ArrayList&lt;String&gt; getUserEatingHistory(String userId, int days) {
<span class="fc" id="L1261">		ArrayList&lt;String&gt; result = new ArrayList&lt;String&gt;();</span>
<span class="fc" id="L1262">		Connection connection = null;</span>
<span class="fc" id="L1263">		PreparedStatement stmtQuery = null;</span>
<span class="fc" id="L1264">		ResultSet rs = null;</span>
		try {
<span class="fc" id="L1266">			connection = this.getConnection();</span>

<span class="fc" id="L1268">			stmtQuery = connection.prepareStatement(</span>
				&quot;SELECT meals &quot; +
				&quot;FROM eating_history &quot; +
				&quot;WHERE userid = ? &quot; +
					&quot;AND date &gt;= CURRENT_DATE - ?&quot;
			);
<span class="fc" id="L1274">			stmtQuery.setString(1, userId);</span>
<span class="fc" id="L1275">			stmtQuery.setInt(2, days);</span>
<span class="fc" id="L1276">			rs = stmtQuery.executeQuery(); </span>
<span class="fc bfc" id="L1277" title="All 2 branches covered.">			while(rs.next()) {</span>
<span class="fc" id="L1278">				result.add(rs.getString(1));</span>
			}
<span class="nc" id="L1280">		} catch (Exception e) {</span>
<span class="nc" id="L1281">			log.info(&quot;Exception while connecting to database: {}&quot;, e.toString());</span>
		} finally {
<span class="nc" id="L1283">			try {</span>
<span class="pc" id="L1284">				rs.close();</span>
<span class="pc" id="L1285">				stmtQuery.close();</span>
<span class="pc" id="L1286">				connection.close();</span>
<span class="nc" id="L1287">			} catch (Exception ex) {</span>
<span class="nc" id="L1288">				log.info(&quot;Exception while closing connection of database: {}&quot;, ex.toString());</span>
<span class="pc" id="L1289">			}</span>
<span class="nc" id="L1290">		}</span>
<span class="fc" id="L1291">		return result;</span>
	}


	/**
	*	Sets the isopen value of the is_campaign_open table
	*
	*	@param state 1 for open; 0 for closed.
	*/
	public void setCampaign(int state) {
<span class="fc" id="L1301">		Connection connection = null;</span>
<span class="fc" id="L1302">		PreparedStatement stmtUpdate = null;</span>
<span class="fc" id="L1303">		String statement = null;</span>
		
		try {
<span class="fc" id="L1306">			connection = this.getConnection();</span>
			
			// Delete url if it already exists
<span class="fc" id="L1309">			stmtUpdate = connection.prepareStatement(</span>
				&quot;DELETE FROM is_campaign_open&quot;
			);
<span class="fc" id="L1312">			stmtUpdate.executeUpdate();</span>

			// Insert campaign state into database
<span class="fc" id="L1315">			stmtUpdate = connection.prepareStatement(</span>
				&quot;INSERT INTO is_campaign_open &quot; +
				&quot;VALUES (?)&quot;
			);
<span class="fc" id="L1319">			stmtUpdate.setInt(1, state);</span>
<span class="fc" id="L1320">			stmtUpdate.executeUpdate();</span>
<span class="nc" id="L1321">		} catch (Exception e) {</span>
<span class="nc" id="L1322">			log.info(&quot;Exception while connecting to database: {}&quot;, e.toString());</span>
		} finally {
<span class="nc" id="L1324">			try {</span>
<span class="pc" id="L1325">				stmtUpdate.close();</span>
<span class="pc" id="L1326">				connection.close();</span>
<span class="nc" id="L1327">			} catch (Exception e) {</span>
<span class="nc" id="L1328">				log.info(&quot;Exception while closing connection to database: {}&quot;, e.toString());</span>
<span class="pc" id="L1329">			}</span>
<span class="nc" id="L1330">		}</span>
<span class="fc" id="L1331">	}</span>


	/**
	*	Determines if the campaign is open.
	*
	*	@return true if campaign is open; false otherwise.
	*/
	public boolean isCampaignOpen() {
<span class="fc" id="L1340">		Connection connection = null;</span>
<span class="fc" id="L1341">		PreparedStatement stmtQuery = null;</span>
<span class="fc" id="L1342">		ResultSet rs = null;</span>
<span class="fc" id="L1343">		boolean result = false;</span>
		try {
<span class="fc" id="L1345">			connection = this.getConnection();</span>

<span class="fc" id="L1347">			stmtQuery = connection.prepareStatement(</span>
				&quot;SELECT isopen &quot; +
				&quot;FROM is_campaign_open&quot;
			);
<span class="fc" id="L1351">			rs = stmtQuery.executeQuery(); </span>
<span class="fc bfc" id="L1352" title="All 2 branches covered.">			while(rs.next()) {</span>
<span class="fc bfc" id="L1353" title="All 2 branches covered.">				if (rs.getInt(1) == 0) {result = false;}</span>
<span class="fc" id="L1354">				else {result = true;}</span>
			}
<span class="nc" id="L1356">		} catch (Exception e) {</span>
<span class="nc" id="L1357">			log.info(&quot;Exception while connecting to database: {}&quot;, e.toString());</span>
		} finally {
<span class="nc" id="L1359">			try {</span>
<span class="pc" id="L1360">				rs.close();</span>
<span class="pc" id="L1361">				stmtQuery.close();</span>
<span class="pc" id="L1362">				connection.close();</span>
<span class="nc" id="L1363">			} catch (Exception ex) {</span>
<span class="nc" id="L1364">				log.info(&quot;Exception while closing connection of database: {}&quot;, ex.toString());</span>
<span class="pc" id="L1365">			}</span>
<span class="nc" id="L1366">		}</span>
<span class="fc" id="L1367">		return result;</span>
	}


	/**
	*	Gets the average daily consumption nutrition info of the specified user over the past input number of days.
	*
	*	@param userId the user's Line ID.
	*	@param days the number of days to obtain the average daily consumption info.
	*	@return a list of average daily consumption nutritional values. The first element is calories(kcal), the second element is sodium(mg), and the third element is fat(g).
	*/
	public ArrayList&lt;Double&gt; getAverageConsumptionInfo(String userId, int days) {
<span class="fc" id="L1379">		ArrayList&lt;Double&gt; result = new ArrayList&lt;Double&gt;();</span>
<span class="fc" id="L1380">		Connection connection = null;</span>
<span class="fc" id="L1381">		PreparedStatement stmtQuery = null;</span>
<span class="fc" id="L1382">		ResultSet rs = null;</span>
<span class="fc" id="L1383">		int numDays = -1;</span>
<span class="fc" id="L1384">		double consumedCalories = 0;</span>
<span class="fc" id="L1385">		double consumedSodium = 0;</span>
<span class="fc" id="L1386">		double consumedFats = 0;</span>
<span class="fc" id="L1387">		ArrayList&lt;String&gt; eatenFoodTypes = new ArrayList&lt;String&gt;();</span>
		try {
<span class="fc" id="L1389">			connection = this.getConnection();</span>

			// Get the number of days
<span class="fc" id="L1392">			stmtQuery = connection.prepareStatement(</span>
				&quot;SELECT COUNT(DISTINCT date) &quot; +
				&quot;FROM eating_history &quot; +
				&quot;WHERE userid = ? &quot; +
					&quot;AND date &gt;= CURRENT_DATE - ?&quot;
			);
<span class="fc" id="L1398">			stmtQuery.setString(1, userId);</span>
<span class="fc" id="L1399">			stmtQuery.setInt(2, days);</span>
<span class="fc" id="L1400">			rs = stmtQuery.executeQuery(); </span>
<span class="fc bfc" id="L1401" title="All 2 branches covered.">			while(rs.next()) {</span>
<span class="fc" id="L1402">				numDays = rs.getInt(1);</span>
			}

			// Collect the food types that the user has consumed
<span class="fc" id="L1406">			stmtQuery = connection.prepareStatement(</span>
				&quot;SELECT food_type &quot; +
				&quot;FROM eating_history &quot; +
				&quot;WHERE userid = ? &quot; +
					&quot;AND date &gt;= CURRENT_DATE - ?&quot;
			);
<span class="fc" id="L1412">			stmtQuery.setString(1, userId);</span>
<span class="fc" id="L1413">			stmtQuery.setInt(2, days);</span>
<span class="fc" id="L1414">			rs = stmtQuery.executeQuery(); </span>
<span class="fc bfc" id="L1415" title="All 2 branches covered.">			while(rs.next()) {</span>
<span class="fc bfc" id="L1416" title="All 2 branches covered.">				for (String food_type: rs.getString(1).split(&quot;,&quot;)) {</span>
<span class="fc" id="L1417">					eatenFoodTypes.add(food_type);</span>
				}
			}

			// Aggregate the total nutritional values that the user has consumed
<span class="fc" id="L1422">			stmtQuery = connection.prepareStatement(</span>
				&quot;SELECT calories_kj, sodium_mg, fat_g &quot; +
				&quot;FROM food_type_nutrient_per_serve &quot; +
				&quot;WHERE food_type = ?&quot;
			);
<span class="fc bfc" id="L1427" title="All 2 branches covered.">			for (String food_type: eatenFoodTypes) {</span>
<span class="fc" id="L1428">				stmtQuery.setString(1, food_type);</span>
<span class="fc" id="L1429">				rs = stmtQuery.executeQuery(); </span>
<span class="fc bfc" id="L1430" title="All 2 branches covered.">				while(rs.next()) {</span>
<span class="fc" id="L1431">					consumedCalories += rs.getDouble(1);</span>
<span class="fc" id="L1432">					consumedSodium += rs.getDouble(2);</span>
<span class="fc" id="L1433">					consumedFats += rs.getDouble(3);</span>
				}
<span class="fc" id="L1435">			}</span>
<span class="nc" id="L1436">		} catch (Exception e) {</span>
<span class="nc" id="L1437">			log.info(&quot;Exception while connecting to database: {}&quot;, e.toString());</span>
		} finally {
<span class="nc" id="L1439">			try {</span>
<span class="pc" id="L1440">				rs.close();</span>
<span class="pc" id="L1441">				stmtQuery.close();</span>
<span class="pc" id="L1442">				connection.close();</span>
<span class="nc" id="L1443">			} catch (Exception ex) {</span>
<span class="nc" id="L1444">				log.info(&quot;Exception while closing connection of database: {}&quot;, ex.toString());</span>
<span class="pc" id="L1445">			}</span>
<span class="nc" id="L1446">		}</span>
<span class="fc" id="L1447">		result.add(consumedCalories/numDays);</span>
<span class="fc" id="L1448">		result.add(consumedSodium/numDays);</span>
<span class="fc" id="L1449">		result.add(consumedFats/numDays);</span>
<span class="fc" id="L1450">		return result;</span>
	}


	/**
	*	Gets the nutrition info of the specified food.
	*
	*	@param food a food.
	*	@return a list of nutritional values. The first element is calories(kcal), the second element is sodium(mg), and the third element is fat(g).
	*/
	public ArrayList&lt;Double&gt; getNutritionInfo(String food) {
<span class="fc" id="L1461">		ArrayList&lt;Double&gt; result = new ArrayList&lt;Double&gt;();</span>
<span class="fc" id="L1462">		Connection connection = null;</span>
<span class="fc" id="L1463">		PreparedStatement stmtQuery = null;</span>
<span class="fc" id="L1464">		ResultSet rs = null;</span>
		try {
<span class="fc" id="L1466">			connection = this.getConnection();</span>

<span class="fc" id="L1468">			stmtQuery = connection.prepareStatement(</span>
				&quot;SELECT &quot; +
					&quot;DISTINCT ON (meal_name) &quot; +
					&quot;? AS meal_name, &quot; +
					&quot;energy_kcal, &quot; +
					&quot;sodium_mg, &quot; +
					&quot;fat_g, &quot; +
					&quot;similarity(?, nutrient_table.description) AS sim &quot; +
				&quot;FROM nutrient_table &quot; +
				&quot;ORDER BY meal_name, sim DESC&quot;
			);
<span class="fc" id="L1479">			stmtQuery.setString(1, food);</span>
<span class="fc" id="L1480">			stmtQuery.setString(2, food);</span>
<span class="fc" id="L1481">			rs = stmtQuery.executeQuery(); </span>
<span class="fc bfc" id="L1482" title="All 2 branches covered.">			while(rs.next()) {</span>
<span class="fc" id="L1483">				result.add(rs.getDouble(2));</span>
<span class="fc" id="L1484">				result.add(rs.getDouble(3));</span>
<span class="fc" id="L1485">				result.add(rs.getDouble(4));</span>
			}
<span class="nc" id="L1487">		} catch (Exception e) {</span>
<span class="nc" id="L1488">			log.info(&quot;Exception while connecting to database: {}&quot;, e.toString());</span>
		} finally {
<span class="nc" id="L1490">			try {</span>
<span class="pc" id="L1491">				rs.close();</span>
<span class="pc" id="L1492">				stmtQuery.close();</span>
<span class="pc" id="L1493">				connection.close();</span>
<span class="nc" id="L1494">			} catch (Exception ex) {</span>
<span class="nc" id="L1495">				log.info(&quot;Exception while closing connection of database: {}&quot;, ex.toString());</span>
<span class="pc" id="L1496">			}</span>
<span class="nc" id="L1497">		}</span>
<span class="fc" id="L1498">		return result;</span>
	}


	/**
	*	Determines if the specified user can claim a cheat day.
	*
	*	@param userId the user's Line ID.
	*	@return true if the user has not claimed a cheat day within the past 7 days; false otherwise.
	*/
	public boolean canClaimCheatDay(String userId) {
<span class="fc" id="L1509">		Connection connection = null;</span>
<span class="fc" id="L1510">		PreparedStatement stmtQuery = null;</span>
<span class="fc" id="L1511">		ResultSet rs = null;</span>
<span class="fc" id="L1512">		boolean result = true;</span>
		try {
<span class="fc" id="L1514">			connection = this.getConnection();</span>

<span class="fc" id="L1516">			stmtQuery = connection.prepareStatement(</span>
				&quot;SELECT meals &quot; +
				&quot;FROM eating_history &quot; +
				&quot;WHERE userid = ? &quot; +
					&quot;AND date &gt;= CURRENT_DATE - 6&quot;
			);
<span class="fc" id="L1522">			stmtQuery.setString(1, userId);</span>
<span class="fc" id="L1523">			rs = stmtQuery.executeQuery(); </span>
<span class="pc bpc" id="L1524" title="1 of 4 branches missed.">			while(result == true &amp;&amp; rs.next()) {</span>
<span class="pc bpc" id="L1525" title="1 of 2 branches missed.">				if (rs.getString(1).equals(&quot;cheat day&quot;)) {</span>
<span class="fc" id="L1526">					result = false;</span>
<span class="fc" id="L1527">					break;</span>
				}
			}
<span class="nc" id="L1530">		} catch (Exception e) {</span>
<span class="nc" id="L1531">			log.info(&quot;Exception while connecting to database: {}&quot;, e.toString());</span>
		} finally {
<span class="nc" id="L1533">			try {</span>
<span class="pc" id="L1534">				rs.close();</span>
<span class="pc" id="L1535">				stmtQuery.close();</span>
<span class="pc" id="L1536">				connection.close();</span>
<span class="nc" id="L1537">			} catch (Exception ex) {</span>
<span class="nc" id="L1538">				log.info(&quot;Exception while closing connection of database: {}&quot;, ex.toString());</span>
<span class="pc" id="L1539">			}</span>
<span class="nc" id="L1540">		}</span>
<span class="fc" id="L1541">		return result;</span>
	}


	/**
	*	Determines if the specified user has exceeded their daily calorie quota.
	*
	*	@param userId the user's Line ID.
	*	@return true if the user has exceed their daily calorie quota, false otherwise.
	*/
	public boolean exceedDailyCalorieQuota(String userId) {
<span class="fc" id="L1552">		Connection connection = null;</span>
<span class="fc" id="L1553">		PreparedStatement stmtQuery = null;</span>
<span class="fc" id="L1554">		ResultSet rs = null;</span>
<span class="fc" id="L1555">		double calorieQuota = 0;</span>
<span class="fc" id="L1556">		double consumedCalories = 0;</span>
<span class="fc" id="L1557">		ArrayList&lt;String&gt; eatenFoodTypes = new ArrayList&lt;String&gt;();</span>
		try {
<span class="fc" id="L1559">			connection = this.getConnection();</span>

			// Retrieve the user's daily calorie quota
<span class="fc" id="L1562">			stmtQuery = connection.prepareStatement(</span>
				&quot;SELECT calories &quot; + 
				&quot;FROM recommended_daily_calories RDC &quot; +
				&quot;JOIN userinfo ON userid = ? &quot; + 
					&quot;AND userinfo.age &gt;= RDC.age_min &quot; + 
					&quot;AND userinfo.age &lt;= RDC.age_max &quot; + 
					&quot;AND userinfo.gender = RDC.gender&quot; 
			);
<span class="fc" id="L1570">			stmtQuery.setString(1, userId);</span>
<span class="fc" id="L1571">			rs = stmtQuery.executeQuery(); </span>
<span class="fc bfc" id="L1572" title="All 2 branches covered.">			while(rs.next()) {</span>
<span class="fc" id="L1573">				calorieQuota = rs.getDouble(1);</span>
			}

			// Collect the food types that the user has consumed today
<span class="fc" id="L1577">			stmtQuery = connection.prepareStatement(</span>
				&quot;SELECT food_type &quot; +
				&quot;FROM eating_history &quot; +
				&quot;WHERE userid = ? &quot; +
					&quot;AND date = CURRENT_DATE&quot;
			);
<span class="fc" id="L1583">			stmtQuery.setString(1, userId);</span>
<span class="fc" id="L1584">			rs = stmtQuery.executeQuery(); </span>
<span class="fc bfc" id="L1585" title="All 2 branches covered.">			while(rs.next()) {</span>
<span class="fc bfc" id="L1586" title="All 2 branches covered.">				for (String food_type: rs.getString(1).split(&quot;,&quot;)) {</span>
<span class="fc" id="L1587">					eatenFoodTypes.add(food_type);</span>
				}
			}

			// Aggregate the total calories that the user has consumed today
<span class="fc" id="L1592">			stmtQuery = connection.prepareStatement(</span>
				&quot;SELECT calories_kj &quot; +
				&quot;FROM food_type_nutrient_per_serve &quot; +
				&quot;WHERE food_type = ?&quot;
			);
<span class="fc bfc" id="L1597" title="All 2 branches covered.">			for (String food_type: eatenFoodTypes) {</span>
<span class="fc" id="L1598">				stmtQuery.setString(1, food_type);</span>
<span class="fc" id="L1599">				rs = stmtQuery.executeQuery(); </span>
<span class="fc bfc" id="L1600" title="All 2 branches covered.">				while(rs.next()) {</span>
<span class="fc" id="L1601">					consumedCalories += rs.getDouble(1);</span>
				}
<span class="fc" id="L1603">			}</span>
<span class="nc" id="L1604">		} catch (Exception e) {</span>
<span class="nc" id="L1605">			log.info(&quot;Exception while connecting to database: {}&quot;, e.toString());</span>
		} finally {
<span class="nc" id="L1607">			try {</span>
<span class="pc" id="L1608">				rs.close();</span>
<span class="pc" id="L1609">				stmtQuery.close();</span>
<span class="pc" id="L1610">				connection.close();</span>
<span class="nc" id="L1611">			} catch (Exception ex) {</span>
<span class="nc" id="L1612">				log.info(&quot;Exception while closing connection of database: {}&quot;, ex.toString());</span>
<span class="pc" id="L1613">			}</span>
<span class="nc" id="L1614">		}</span>
<span class="fc bfc" id="L1615" title="All 2 branches covered.">		if (consumedCalories &gt;= calorieQuota) {return true;}</span>
<span class="fc" id="L1616">		else {return false;}</span>
	}


	/**
	*	Deletes all records corresponding to the specified user from the input table.
	*
	*	@param userId the user's Line ID.
	*	@param table the database table to delete records from.
	*/
	public void reset(String userId, String table) {
<span class="fc" id="L1627">		Connection connection = null;</span>
<span class="fc" id="L1628">		PreparedStatement stmtUpdate = null;</span>
<span class="fc" id="L1629">		String statement = null;</span>
		
		try {
<span class="fc" id="L1632">			connection = this.getConnection();</span>
			
			// Deletes records corresponding to the user from the input table
<span class="fc" id="L1635">			statement = &quot;DELETE FROM &quot; + table + &quot; WHERE userid = ?&quot;;</span>
<span class="fc" id="L1636">			stmtUpdate = connection.prepareStatement(statement);</span>
<span class="fc" id="L1637">			stmtUpdate.setString(1, userId);</span>
<span class="fc" id="L1638">			stmtUpdate.executeUpdate();</span>
<span class="fc" id="L1639">		} catch (Exception e) {</span>
<span class="fc" id="L1640">			log.info(&quot;Exception while connecting to database: {}&quot;, e.toString());</span>
		} finally {
<span class="nc" id="L1642">			try {</span>
<span class="pc" id="L1643">				stmtUpdate.close();</span>
<span class="pc" id="L1644">				connection.close();</span>
<span class="nc" id="L1645">			} catch (Exception e) {</span>
<span class="nc" id="L1646">				log.info(&quot;Exception while closing connection to database: {}&quot;, e.toString());</span>
<span class="pc" id="L1647">			}</span>
<span class="nc" id="L1648">		}</span>
<span class="fc" id="L1649">	}</span>


	/**
	*	Deletes all records corresponding to the specified requestuser from the coupon_code table.
	*
	*	@param requestUserId the user's Line ID.
	*/
	public void resetCoupon(String requestUserId) {
<span class="fc" id="L1658">		Connection connection = null;</span>
<span class="fc" id="L1659">		PreparedStatement stmtUpdate = null;</span>
		
		try {
<span class="fc" id="L1662">			connection = this.getConnection();</span>
			
<span class="fc" id="L1664">			stmtUpdate = connection.prepareStatement(</span>
				&quot;DELETE FROM coupon_code &quot; +
				&quot;WHERE requestuser = ?&quot;
			);
<span class="fc" id="L1668">			stmtUpdate.setString(1, requestUserId);</span>
<span class="fc" id="L1669">			stmtUpdate.executeUpdate();</span>
<span class="nc" id="L1670">		} catch (Exception e) {</span>
<span class="nc" id="L1671">			log.info(&quot;Exception while connecting to database: {}&quot;, e.toString());</span>
		} finally {
<span class="nc" id="L1673">			try {</span>
<span class="pc" id="L1674">				stmtUpdate.close();</span>
<span class="pc" id="L1675">				connection.close();</span>
<span class="nc" id="L1676">			} catch (Exception e) {</span>
<span class="nc" id="L1677">				log.info(&quot;Exception while closing connection to database: {}&quot;, e.toString());</span>
<span class="pc" id="L1678">			}</span>
<span class="nc" id="L1679">		}</span>
<span class="fc" id="L1680">	}	</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.8.201612092310</span></div></body></html>